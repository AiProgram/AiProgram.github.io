---
title: Java并发锁
date: 2020-08-07 14:18:04
tags:
categories:
- Java
- 多线程
---

# Java并发锁

## CAS操作

<!-- more -->

+ CAS是Compare And Set的缩写，它是一种不加锁并发修改变量的方法。
+ CAS使结合了两种方法：`Unsafe`类调用系统原生方法，然后使用CPU原语保证CAS的原子性。在set不成功时自旋（while死循环），直到修改成功（自旋的终止条件要视操作而定）。

### CAS理解

+ CAS涉及三个值：内存中目前实际值V、预期的原始数值A、希望把原始值更新成的A值。CAS会比对V、A，若V==A就执行修改，修改成功后返回。
+ 具体原理：
  1. 首先如果没有其他线程干扰就不用说了。
  2. 如果有多个线程竞争修改同一值，我们考虑**第一种情况**：除本线程外的其他线程只会把内存值修改为非A的值，这时我们只要比对V、A就知道是否有其他线程先一步修改。当V!=A时就有其他线程修改，此时我们放弃修改，否则我们可以顺利修改并且操作是原子（没有其他线程插入）的。
  3. 我们考虑**第一种情况的漏洞**：ABA问题，就是说我们准备修改时，有线程把原始值A改成了B然后又改成了A。这个时候原值比对成功，但是我们如果修改不再是原子性的了，因为从我们获取原值到比对成功再修改的中间有其他线程修改了。这种误判的避免可以使用**值+时间戳**的方法解决。